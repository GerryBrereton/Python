__author__ = 'jkordish'
# -*- coding: utf-8 -*-
'''Compare the list of known ip/cve pairs and the ones pulled from cvedetails'''


import csv
import urllib2
from bs4 import BeautifulSoup


old = tuple(csv.reader(open('data/old.csv', "rb"),dialect='excel'))
new = tuple(csv.reader(open('data/new2.csv', "rb"),dialect='excel'))
ofile = writer = csv.writer(open('data/NotFoundExportLarge.csv', 'wb'))


#NotFound = [x for x in new if x not in old]

oldset = set(map(tuple, old))
newset = set(map(tuple, new))

NotFound = list(newset.difference(oldset))

data = []

for row in NotFound:
    url = 'http://www.cvedetails.com/cve/'+row[1]
    soup = BeautifulSoup(urllib2.urlopen(url).read())
    CVE = soup.find(attrs={"name":"description"})['content'].split(':', 1)
    CVSS = soup.find('div', attrs={'class' : 'cvssbox'})
    DESC = soup.html.head.title.string.split(':', 1)[1]
    if str(CVSS.contents[0]) > '6.9':
        print str(CVSS.contents[0])
#        print (row[0], CVE[0].strip(), str(DESC), str(CVSS.contents[0]),CVE[1].lstrip())
        data.append((row[0], CVE[0].strip(), str(DESC), str(CVSS.contents[0]),CVE[1].lstrip()))



writer.writerow(['IP','CVE','Desc','CVSS','Detail'])
for row in data:
    ofile.writerow(row)
