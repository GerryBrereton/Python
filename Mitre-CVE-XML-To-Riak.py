__author__ = 'jkordish'
# -*- coding: utf-8 -*-
'''Experiment taking CVE data from MITRE and injecting it into a Riak cluster'''


from lxml import etree
import riak


def main():
    '''main'''
    mitre_xml_import()

def mitre_xml_import():
    '''Pull in the xml file from mitre containing all CVEs'''
    tree = etree.parse('data/allitems.xml')
    root = tree.getroot()

    eitem="{http://cve.mitre.org/cve/downloads}item"
    edesc="{http://cve.mitre.org/cve/downloads}desc"
    erefs="{http://cve.mitre.org/cve/downloads}refs"
    estatus="{http://cve.mitre.org/cve/downloads}status"
    ephase="{http://cve.mitre.org/cve/downloads}phase"
    ecomments="{http://cve.mitre.org/cve/downloads}comments"
    evotes="{http://cve.mitre.org/cve/downloads}votes"

    d = {}

    for entry in root.iter(eitem):
        id = (entry.get("name"))
        name = {}
        name = {key: value for (key, value) in entry.items()}
        for cve in entry.iterchildren():
            try:
                if cve.tag == estatus:
                    status = {}
                    status['Status'] = (cve.text)
            except:
                pass
            try:
                if cve.tag == ephase:
                    phase = {}
                    phase['Date'] = (cve.get('date'))
            except:
                pass
            try:
                if cve.tag == edesc:
                    desc = {}
                    desc['Description'] = (cve.text)
            except:
                pass
        d[id] = (name, status, phase, desc)
    riak_store(d)

def riak_store(data):
    '''push data into the riak cluster'''
    data = data

    client = riak.RiakClient(host='10.120.10.237', port=8098)

    cve_bucket = client.bucket('cve')


    for key,value in data.items():
        try:
            cve_put = cve_bucket.new(str(key), data=value)
            cve_put.store()
        except:
            pass

if __name__ == '__main__':
    main()